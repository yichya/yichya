---
layout: post
title: Fuck up WO-27s (Huawei HG8321R) (1)
categories:
  - Small Things
tags:
  - gadget
  - router
---

## Background

家里接入了光纤，顺便还有一个用户端设备。本来以为用户端设备就是一个类似于 ADSL Modem 的玩意儿，一个电话线口 + 一个以太网口，使用的时候只要把以太网口直接连上路由器再用路由器顺便拨号就行了，也就没想太多。

后来老爸打电话过来说不知道怎么接才能用。草民的路由是自己魔改的 HG556A，四个 LAN 口利用 OpenWrt 的虚拟 LAN 口功能划分成一个 WAN 和三个 LAN。想来确实只有我自己知道哪个口是 WAN，于是干脆让我爸挨个试。我爸把所有可能的 12 种接法都试过之后还是说不能用……这怎么可能嘛。于是让我爸先用一下隔壁的 WiFi（说来惭愧这个是去年寒假破解掉的 hhh **请一定注意关闭路由器的 WPS 功能**）

<!-- more -->

## Spot the Problem

终于回家了。看了下那个用户端设备，一脸卧槽。居然有两个 LAN 接口……我猜到问题是什么了。

进了下管理界面更卧槽，这特么也叫管理界面呵呵呵呵。

![admin_login](http://blog.yichyaqc.cn/assets/images/fuck-up-wo27s/fuck_wo27s_admin_login.png)

简直丑哭。

![admin_wan](http://blog.yichyaqc.cn/assets/images/fuck-up-wo27s/fuck_wo27s_admin_wan.png)

![admin_wan_info](http://blog.yichyaqc.cn/assets/images/fuck-up-wo27s/fuck_wo27s_admin_wan_info.png)

WAN 口就这点儿功能，还一眼就看到了 TR069。心中一千万匹草泥马呼啸而过。

![admin_wan_gpl](http://blog.yichyaqc.cn/assets/images/fuck-up-wo27s/fuck_wo27s_admin_gpl.png)

开源软件许可协议页面。内核还挺新，2.6.34.10 hhhhh

看了下电脑的 IP，还有无线路由器的配置，很明显，问题就是 DHCP 冲突而已。把用户端设备的 LAN 线接到路由器的 WAN 口上，重启，网络使用一切正常。并没有什么问题。

想来三台设备一块儿启动的时候会出现这样的问题：电脑发送 DHCP 请求，这时无线路由器的交换机处在未配置状态，于是请求被直接转发给光纤用户端设备，用户端设备把回应直接发给电脑。这样无线路由的 DHCP 就被直接无视了。

## Find Solution

那么，草民想到的解决方案有三个：

* **Do Nothing Plan：** 保持目前状态，什么也不做。使用的时候保证电脑在无线路由器启动完成后再启动。
* **Plan A：** 把光纤用户端的 DHCP 功能关闭，避免电脑提前接收到错误的 DHCP 回应。相当于搞残掉光纤用户端的路由功能。
* **Plan B：** 配置光纤用户端进行 PPPoE 认证，角色变为上级路由；无线路由器作为第二级路由。或者也可以在这种方案下进行桥接。

Do Nothing Plan 也能完成工作，不过如果电脑在路由器完成启动前进行了 DHCP 就会出问题，此时就需要重启电脑了。

Plan A 草民认为相对理想。设备各司其职，方便管理和可能的替换。

Plan B 比较传统，会带来常见的比如性能损失、不便于管理这样的一些问题。而且有用户反映，这一用户端设备的 NAT 性能较差，实际使用时最好用普通的路由器进行路由。

## Do Nothing Plan

草民首先使用的是 Do Nothing Plan。不过在使用中发现有时 DNS 会出现问题，那么调整无线路由器的 DHCP 设置：添加 DHCP 选项 `6,119.29.29.29` 强制客户端使用 DNSPod 服务器即可。

感觉这么做延迟好像有一点点高，不知道是不是错觉。网速似乎倒是正常。

## Plan A (1) - Disable DHCP the easy way

想禁用光纤客户端上的 DHCP 的话，可以想到一个很简单的办法，就是在光纤用户端进行设置，丢弃来自 UDP 67 端口的数据包。有两种方法：

* 直接禁止该端口的访问。
* 将一切来自该端口的数据包转发至某个不存在的地址。

禁止端口访问可以很简单的把来自这一端口的数据包 Drop 掉，或者 Reject 也可以。在这里添加规则：

![admin_ipfilter](http://blog.yichyaqc.cn/assets/images/fuck-up-wo27s/fuck_wo27s_admin_ipfilter.png)

只能 Drop 了。这啥破玩意儿，呵呵。

测试一下。

![ipfilter_fail](http://blog.yichyaqc.cn/assets/images/fuck-up-wo27s/fuck_wo27s_ipfilter_fail.png)

然而 DHCP 似乎仍然可以正常的工作，而且还把网络搞挂了……看来这样不行。

那么换下一种方法，然而……找了半天发现这破玩意儿根本不支持转发功能。明明开源软件许可协议里面有 iptables 的。

## Fuck the system up - Get Lost, China Unicom

看来现在我们遇到了联通给我们人为带来的一系列麻烦，那我们就需要获得路由器的最高控制权限了。

STFW 之后得到这样一些材料：

* [发一个HG8321R的开启telnet，超级用户和通用版的教程，带工具和固件](http://www.chinadsl.net/forum.php?mod=viewthread&tid=124033)
* [HG8321R 拆解](http://www.chinadsl.net/forum.php?mod=viewthread&tid=124175)

华为好像做了一些很可怕的事情，莫非是检查所有的数据包然后一旦发现特定数据包就允许 Telnet 或者进入固件更新模式吗……

于是要做的事情应该比较简单：

1. 利用工具将设备降级，并开启 Telnet。
2. 备份配置。
3. 还原出厂状态。
4. 恢复配置，确保网络能够正常使用。
5. 在管理员界面中试着禁用 DHCP、关闭路由功能，或者打开 PPPoE。 

Update: 由于未能成功获得设备的最高权限，这个坑暂时弃掉了，有空再填 T_T

